<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Japanese Flashcards (Pyodide)</title>
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background-color: #111217;
  color: #f6f8ff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  height: 100vh;
}
header {
  width: 100%;
  padding: 12px;
  background: #22252b;
  display: flex;
  justify-content: space-between;
}
button {
  padding: 8px 14px;
  margin: 0 4px;
  background: #22252b;
  color: #e6eef8;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
button:hover { background: #2b3038; }
#flashcard {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 24px;
  max-width: 800px;
  width: 100%;
}
#word { font-size: 3rem; font-weight: bold; }
#translation { margin-top: 12px; font-size: 1.2rem; color: #cbd5e1; }
.difficulty-buttons { margin-top: 24px; }
.difficulty-buttons button { padding: 10px 16px; font-size: 1rem; }
</style>
</head>
<body>

<header>
  <div>
    <button id="shuffleBtn">Shuffle</button>
    <button id="showKanaBtn">Show Kana</button>
  </div>
  <div>
    <button id="exportBtn">Export Progress</button>
  </div>
</header>

<div id="flashcard">
  <div id="word">Loading...</div>
  <div id="translation"></div>
  <div class="difficulty-buttons">
    <button data-quality="5">Easy</button>
    <button data-quality="4">Medium</button>
    <button data-quality="2">Hard</button>
    <button id="skipBtn">Skip</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<script>
let pyodide, cards = [], currentIndex = 0;

// Initialize Pyodide
async function initPyodide() {
  pyodide = await loadPyodide();
  await pyodide.loadPackage(['micropip']);
  await loadSRSAndCSV();
  showCard();
}

// Load SRS.py and CSV automatically
async function loadSRSAndCSV() {
  const srsCode = await (await fetch('SRS.py')).text();
  pyodide.runPython(srsCode);

  const csvText = await (await fetch('japanese_flashcards.csv')).text();
  pyodide.globals.set('csv_text', csvText);

  pyodide.runPython(`
import csv
from io import StringIO

reader = csv.DictReader(StringIO(csv_text), fieldnames=['id','word_phrase','translation'])
cards = []
for row in reader:
    card = dict(row)
    # Initialize SRS fields
    import SRS
    srs_card = SRS.init_card(card['id'])
    card.update(srs_card)
    cards.append(card)
`);
  cards = pyodide.globals.get('cards').toJs();
}

// Show current card
function showCard() {
  if (cards.length === 0) return;
  const card = cards[currentIndex];
  document.getElementById('word').textContent = card.word_phrase;
  document.getElementById('translation').textContent = card.translation;
}

// Shuffle
document.getElementById('shuffleBtn').addEventListener('click', () => {
  cards.sort(() => Math.random() - 0.5);
  currentIndex = 0;
  showCard();
});

// Show Kana button
document.getElementById('showKanaBtn').addEventListener('click', () => {
  const card = cards[currentIndex];
  if (!card.kana) {
    const k = prompt('Enter kana for: ' + card.word_phrase);
    if(k) card.kana = k;
  }
  const display = document.getElementById('word');
  display.textContent = display.textContent === card.word_phrase ? card.kana || card.word_phrase : card.word_phrase;
});

// Skip
document.getElementById('skipBtn').addEventListener('click', () => {
  currentIndex = (currentIndex + 1) % cards.length;
  showCard();
});

// Difficulty buttons
document.querySelectorAll('.difficulty-buttons button[data-quality]').forEach(btn => {
  btn.addEventListener('click', async () => {
    const q = parseInt(btn.dataset.quality);
    const card = cards[currentIndex];
    pyodide.globals.set('current_card', card);
    pyodide.globals.set('quality', q);
    await pyodide.runPythonAsync(`
import SRS
updated = SRS.update_review(current_card, quality)
current_card.update(updated)
`);
    currentIndex = (currentIndex + 1) % cards.length;
    showCard();
  });
});

// Export progress
document.getElementById('exportBtn').addEventListener('click', () => {
  const csv = ['id,word_phrase,translation,kana,efactor,interval,repetition,due_date'];
  for (const c of cards) {
    csv.push([c.id, c.word_phrase, c.translation, c.kana || '', c.efactor, c.interval, c.repetition, c.due_date].join(','));
  }
  const blob = new Blob([csv.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'flashcards_progress.csv';
  a.click();
  URL.revokeObjectURL(url);
});

// Start
initPyodide();
</script>

</body>
</html>
  }
  #flashcard {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 24px;
    max-width: 800px;
    width: 100%;
  }
  #word {
    font-size: 3rem;
    font-weight: bold;
  }
  #translation {
    margin-top: 12px;
    font-size: 1.2rem;
    color: #cbd5e1;
  }
  .difficulty-buttons {
    margin-top: 24px;
  }
  .difficulty-buttons button {
    padding: 10px 16px;
    font-size: 1rem;
  }
  input[type="file"] {
    display: none;
  }
  label.file-btn {
    cursor: pointer;
    padding: 8px 14px;
    background: #22252b;
    color: #e6eef8;
    border-radius: 6px;
  }
</style>
</head>
<body>

<header>
  <div>
    <label class="file-btn">Load CSV<input type="file" id="csvFile" accept=".csv"></label>
    <button id="shuffleBtn">Shuffle</button>
    <button id="showKanaBtn">Show Kana</button>
  </div>
  <div>
    <button id="exportBtn">Export Progress</button>
  </div>
</header>

<div id="flashcard">
  <div id="word">Loading...</div>
  <div id="translation"></div>
  <div class="difficulty-buttons">
    <button data-quality="5">Easy</button>
    <button data-quality="4">Medium</button>
    <button data-quality="2">Hard</button>
    <button id="skipBtn">Skip</button>
  </div>
</div>

<script>
let cards = [];
let currentIndex = 0;

// Load from localStorage
function loadProgress() {
  const saved = localStorage.getItem('flashcardsProgress');
  return saved ? JSON.parse(saved) : {};
}
let progress = loadProgress();

function saveProgress() {
  localStorage.setItem('flashcardsProgress', JSON.stringify(progress));
}

// Parse CSV
function parseCSV(text) {
  const lines = text.split('\n').filter(l => l.trim());
  return lines.map(line => {
    const [id, word, translation] = line.split(',');
    return {id, word, translation, kana: null};
  });
}

function showCard() {
  if(cards.length === 0) return;
  const card = cards[currentIndex];
  const prog = progress[card.id] || {efactor:2.5, interval:0, repetition:0, dueDate:new Date().toISOString().split('T')[0]};
  card.efactor = prog.efactor;
  card.interval = prog.interval;
  card.repetition = prog.repetition;
  card.dueDate = prog.dueDate;

  document.getElementById('word').textContent = card.word;
  document.getElementById('translation').textContent = card.translation;
}

// Shuffle cards
document.getElementById('shuffleBtn').addEventListener('click', () => {
  cards.sort(() => Math.random()-0.5);
  currentIndex = 0;
  showCard();
});

// Show Kana (prompt)
document.getElementById('showKanaBtn').addEventListener('click', () => {
  const card = cards[currentIndex];
  if(!card.kana) {
    const k = prompt('Enter kana for: ' + card.word);
    if(k) card.kana = k;
  }
  const display = document.getElementById('word');
  display.textContent = display.textContent === card.word ? card.kana : card.word;
});

// Skip
document.getElementById('skipBtn').addEventListener('click', () => {
  currentIndex = (currentIndex + 1) % cards.length;
  showCard();
});

// Difficulty buttons
document.querySelectorAll('.difficulty-buttons button[data-quality]').forEach(btn => {
  btn.addEventListener('click', () => {
    const quality = parseInt(btn.dataset.quality);
    reviewCard(quality);
    currentIndex = (currentIndex + 1) % cards.length;
    showCard();
  });
});

// SM-2 algorithm
function reviewCard(q) {
  const card = cards[currentIndex];
  const p = progress[card.id] || {efactor:2.5, interval:0, repetition:0, dueDate:new Date().toISOString().split('T')[0]};
  if(q < 3){
    p.repetition = 0;
    p.interval = 1;
  } else {
    p.repetition += 1;
    if(p.repetition === 1) p.interval = 1;
    else if(p.repetition === 2) p.interval = 6;
    else p.interval = Math.round(p.interval * p.efactor);
  }
  let ef = p.efactor + (0.1 - (5-q)*(0.08 + (5-q)*0.02));
  if(ef < 1.3) ef = 1.3;
  p.efactor = ef;
  const nextDate = new Date();
  nextDate.setDate(nextDate.getDate() + p.interval);
  p.dueDate = nextDate.toISOString().split('T')[0];
  progress[card.id] = p;
  saveProgress();
}

// Load CSV
document.getElementById('csvFile').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    cards = parseCSV(reader.result);
    currentIndex = 0;
    showCard();
  };
  reader.readAsText(file, 'utf-8');
});

// Export progress
document.getElementById('exportBtn').addEventListener('click', () => {
  const csv = ['id,word,translation,kana,efactor,interval,repetition,dueDate'];
  cards.forEach(c => {
    const p = progress[c.id] || {efactor:2.5, interval:0, repetition:0, dueDate:''};
    csv.push([c.id, c.word, c.translation, c.kana || '', p.efactor, p.interval, p.repetition, p.dueDate].join(','));
  });
  const blob = new Blob([csv.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'flashcards_progress.csv';
  a.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
